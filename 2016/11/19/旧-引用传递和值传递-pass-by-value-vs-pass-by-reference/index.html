<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> [旧]引用传递和值传递(pass by value vs pass by reference) · flyer</title><meta name="description" content="[旧]引用传递和值传递(pass by value vs pass by reference) - flyer"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="flyer"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/flyer88xu" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/flyer88" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">[旧]引用传递和值传递(pass by value vs pass by reference)</h1><div class="post-info">Nov 19, 2016</div><div class="post-content"><p>记录这个的原因主要是今天看到了<a href="https://www.zhihu.com/question/31203609" target="_blank" rel="external">知乎的一个问题</a>，发现自己有些地方有点懵逼，写下来记录一下，<a href="http://zhihu.com/question/31203609/answer/50992895" target="_blank" rel="external">知乎上排名第一的答案</a>说的很清楚，不过看了以后依旧有点迷迷糊糊，所以自己写了个几行代码测试。<br>首先上一个，感觉比较对的结论：<br><strong>Horstmann的《java核心技术》（中文第8版P115-P117）原文描述：<br>”java程序设计语言总是采用值调用。也就是说，方法得到的是所有参数值的一个拷贝，特别是，方法不能修改传递给它的任何参数变量的内容。“<br>”有些程序员（甚至是本书的作者），认为java程序设计语言对对象采用的是引用调用，实际上这种理解是不对的。”</strong><br>然后补充几句我的理解：</p>
<ol>
<li>首先，Java在传递过程中，传递的只有值，但是表现出来的形式，却既有值传递也有引用传递，因此，没必要纠结于名字，能理解原理即可。</li>
<li>在传递对象进函数时，对象的所有数据会被拷贝到局部变量中，这也就导致了局部变量修改其成员变量值时会导致原始的变量的成员变量值产生响应的改变，因为他们持有的成员变量的引用指向了同一个地址块(内存空间)。</li>
<li>而对于传递8种基本变量时，也只是拷贝了值，因此对基本变量其本身的修改，无法导致原始变量的的修改。</li>
<li>不过这里需要考虑特殊情况，就是String，其表现形式和8种基本变量一样，具体下文有分析，而对于String为何要这么做，我也不清楚，不是很懂 jvm 和 Java 的设计。</li>
</ol>
<hr>
<hr>
<h2 id="一-_值类型和引用类型（此处先不考虑String）的传递：">一. 值类型和引用类型（此处先不考虑String）的传递：</h2><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestReference</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        Student student = <span class="keyword">new</span> Student();</span><br><span class="line">        student.age = <span class="number">10</span>;</span><br><span class="line">        System.<span class="keyword">out</span>.println(student.age);<span class="comment">//10</span></span><br><span class="line">        addAge(student);</span><br><span class="line">        System.<span class="keyword">out</span>.println(student.age);<span class="comment">//11</span></span><br><span class="line">        addAge(student.age);</span><br><span class="line">        System.<span class="keyword">out</span>.println(student.age);<span class="comment">//11</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAge</span><span class="params">(Student paramStudent)</span></span>&#123;</span><br><span class="line">        paramStudent.age = <span class="number">11</span>;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAge</span><span class="params">(<span class="keyword">int</span> paramAge)</span></span>&#123;</span><br><span class="line">        paramAge = <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对以上代码进行解释</p>
<ul>
<li>首先<code>addAge(student)</code>调用的是<code>addAge(Student paramStudent)</code>，该部分其实很好理解，首先，<code>paramStudet</code>对象，拷贝了传入的<code>studet</code>对象所有的数据，因此<code>paramStudet</code>它所指向的地址，其实和<code>student</code>是一样的，所以，当<code>paramStudent</code>改变它的<code>age</code>值时，其触发的操作和<code>student</code>改变<code>age</code>的值是一样的 ,因为他们都指向了同一个地址块。</li>
<li>其次<code>addAge(student.age)</code>调用的是<code>addAge(int paramAge)</code>，也很好理解，<code>paramAge</code>也只是拷贝了<code>studet.age</code>的值，此处为10，然后改变了<code>paramAge</code>的值，但此时<code>paramAge</code>与引用类型不同，它保存的只有一个值，所以其实这个<code>parmaAge</code>作为一个局部变量，并不能对原本的<code>student.age</code>产生任何影响</li>
</ul>
<h2 id="二-_String的问题：">二. String的问题：</h2><h3 id="1-_String问题来源">1. String问题来源</h3><p>上面的例子其实很好搞清楚，但是我在碰到String的时候就有点懵逼了,如果调用以下方法，结果会如注释显示。</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">    Student student = <span class="keyword">new</span> Student();</span><br><span class="line">    student.age = <span class="number">10</span>;</span><br><span class="line">    student.name = <span class="string">"dove"</span>;</span><br><span class="line">    changeName(student);</span><br><span class="line">    System.<span class="keyword">out</span>.println(student.name);<span class="comment">//dove_2</span></span><br><span class="line">    changeName(student.name);</span><br><span class="line">    System.<span class="keyword">out</span>.println(student.name);<span class="comment">//dove_2</span></span><br><span class="line">    changeName2(student.name); </span><br><span class="line">    System.<span class="keyword">out</span>.println(student.name);<span class="comment">//dove_2         </span></span><br><span class="line">&#125;      </span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">changeName</span><span class="params">(Student paramStudent)</span></span>&#123;</span><br><span class="line">    paramStudent.name = <span class="string">"dove_2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">changeName</span><span class="params">(String paramName)</span></span>&#123;</span><br><span class="line">    paramName = <span class="string">"dove_3"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">changeName2</span><span class="params">(String paramName)</span></span>&#123;</span><br><span class="line">    paramName += <span class="string">"233"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>changeName2(String paramName)</code>此处讲道理被调用后应该是”dove_2233”,因为<code>String</code>是一个引用类型,也就是说此处的<code>parmaName</code>应该是指向和传入的参数指向了相同的一个地址块，然后对指向的内存进行了修改,然而结果并不是,原因就在于<code>String</code>是一个不可变的类型(为啥不可变呢,具体可以看<code>String</code>类的实现,它是一个<code>final class</code>,并且其内部正真保存着字符串的<code>value[]</code>也是不可变的(<code>final</code>)，所以意味着修改<code>Sting</code>是不可能的)。</p>
<h3 id="2-脑洞猜想可能情况">2.脑洞猜想可能情况</h3><p>所以猜测上述的<code>changeName2</code>过程类似于</p>
<figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FuckString fuckString = <span class="keyword">new</span> FuckString();<span class="comment">//paramName</span></span><br><span class="line">FuckString fuckString2 = <span class="keyword">new</span> FuckString(fuckString);<span class="comment">//构造出的新的值</span></span><br><span class="line">fuckString = fuckString2;<span class="comment">//把paramName指向构造出的新值</span></span><br></pre></td></tr></table></figure>
<p>然后，这就有点想不通了，不可变的类型，String 的 <code>+</code> 是怎么弄的呢？打个断点试试看，强制进入，发现跳转到了StringBuilder的构造方法里，这说明应该是构造了一个新的StringBuilder对象。      </p>
<p><img src="~/19-58-14.jpg" alt=""></p>
<p>同时，底部的Debug里抛出了个错误，说是无法获取<code>StringBuilder.toString()</code>,也就进一步证明此处有新的<code>String</code>的产生。<br><img src="http://ob9rvakdw.bkt.clouddn.com/19-58-59.jpg" alt=""><br>到这里基本上就验证了我的猜想，<code>String</code> <code>+</code>会产生一个新的<code>String</code>对象，既然这样，反编译下，看下字节码，估计基本就搞定这个懵逼的问题了。</p>
<h3 id="3-字节码验证">3.字节码验证</h3><p>于是就写了以下的类，用来验证：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Main</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        String s = <span class="string">"dove"</span>;</span><br><span class="line">        s += <span class="string">"233"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后javac，然后javap -c，看字节码,如下图。</p>
<p><img src="http://ob9rvakdw.bkt.clouddn.com/20-03-38.png" alt=""><br>尝试着解释下该部分代码（不是很看的懂字节码，所以有些解释可能不是很规范，不过讲道理大概意思不会差很远)</p>
<ul>
<li><code>String s = &quot;dove&quot;;</code>部分字节码及解释</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">0</span>: <span class="string">ldc           #2                  // String dove</span></span><br><span class="line"><span class="attribute">2</span>: <span class="string">astore_1</span></span><br></pre></td></tr></table></figure>
<p>第0行，将一个常量加载到操作数栈,也就是把“dove”这玩意，放进了操作数栈(也不知道是什么东西，蛤蛤)<br>第2行，将一号数值（下划线1代表一号，大概理解，不是很准确）从操作数栈存储到局部变量表，说白了就是把“dove”给存了起来？</p>
<ul>
<li><code>s += &quot;233&quot;;</code>部分字节码及解释</li>
</ul>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="attribute">3</span>: <span class="string">new           #3                  // class java/lang/StringBuilder</span></span><br><span class="line"> <span class="attribute">6</span>: <span class="string">dup</span></span><br><span class="line"> <span class="attribute">7</span>: <span class="string">invokespecial #4                  // Method java/lang/StringBuilder."&lt;init&gt;":()V</span></span><br><span class="line"><span class="attribute">10</span>: <span class="string">aload_1    </span></span><br><span class="line"><span class="attribute">11</span>: <span class="string">invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line"><span class="attribute">14</span>: <span class="string">ldc           #6                  // String 233</span></span><br><span class="line"><span class="attribute">16</span>: <span class="string">invokevirtual #5                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;</span></span><br><span class="line"><span class="attribute">19</span>: <span class="string">invokevirtual #7                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;</span></span><br></pre></td></tr></table></figure>
<p>第3行，这个很明显，不google也知道，<code>new StringBuilder()</code>，也就是搞了个<code>StringBUilder</code>的实例。<br>第6行，Java虚拟机提供了一些用于直接操作操作数栈，不是很懂，貌似对整体理解影响不大，先过。<br>第7行，invokespecial 调用一些需要特殊处理的实例方法，包括实例初始化方法、私有方法和父类方法，此处应该是在初始化StringBuilder对象。<br>第10行，将1号局部变量(下划线1指代一号变量)加载到操作栈，这里应该是指“dove”<br>第11行，调用对象的实例方法,此处就是调用<code>StringBuilder.append</code>,也就是把“dove”加到了<code>StringBuilder</code>中<br>第14行，将一个常量加载到操作数栈，就是把“233”载入<br>第16行，调用对象的实例方法,此处就是调用<code>StringBuilder.append</code>，把“233”给加到“StringBuilder”中<br>第19行，调用对象的实例方法,此处就是调用<code>StringBuilder.toString</code>，而该方法，会触发<code>new String()</code>的操作，因此，会返还一个新的<code>String</code>对象</p>
<h3 id="4-最终结论：">4.最终结论：</h3><p>从脑洞断点以及最后的字节码分析可以看出，<code>s +=&quot;233&quot;</code>,会导致一个新的String对象生成，也就是说，调用<code>changeName2(String paramName)</code>会使得<code>paramName</code>指向一个新的String对象，这样就意味着，对该数据的改变并不会影响本身<code>student.name</code>的值,由此，String懵逼的问题也解决了。</p>
<hr>
<hr>
<p>以上，就是整个关于Java引用传递和值传递的理解，有说的不对的，望指正。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/19/旧-Android-贝塞尔曲线，QQ-删除小红点类似效果实现/" class="prev">上一篇</a><a href="/2016/11/19/旧-Android-代码混淆-二/" class="next">下一篇</a></div><div data-thread-key="2016/11/19/旧-引用传递和值传递-pass-by-value-vs-pass-by-reference/" data-title="[旧]引用传递和值传递(pass by value vs pass by reference)" data-url="http://yoursite.com/2016/11/19/旧-引用传递和值传递-pass-by-value-vs-pass-by-reference/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"baiyanwu"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2016 <a href="http://yoursite.com">flyer</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>