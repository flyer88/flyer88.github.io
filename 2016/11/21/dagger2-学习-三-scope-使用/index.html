<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> dagger2 学习(三)- scope 使用 · flyer</title><meta name="description" content="dagger2 学习(三)- scope 使用 - flyer"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://dove.im/atom.xml" title="flyer"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/flyer88xu" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/flyer88" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">dagger2 学习(三)- scope 使用</h1><div class="post-info">Nov 21, 2016</div><div class="post-content"><h2 id="关于Scope"><a href="#关于Scope" class="headerlink" title="关于Scope"></a>关于<code>Scope</code></h2><p>Dagger 2 自带的 <code>Scope</code> 只有一个 <code>@Singleton</code> ，其他的可以通过自定义来实现</p>
<p><a href="https://github.com/flyer88/LearnDagger2/tree/%E5%AD%A6%E4%B9%A03Scope-%E4%BD%BF%E7%94%A8" target="_blank" rel="external">本文代码</a></p>
<h3 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h3><h4 id="1-Scope-的作用，就是提供在当前-Component-实例-范围内的单例。"><a href="#1-Scope-的作用，就是提供在当前-Component-实例-范围内的单例。" class="headerlink" title="(1)  Scope 的作用，就是提供在当前 Component 实例 范围内的单例。"></a>(1)  <code>Scope</code> 的作用，就是提供在当前 <code>Component</code> 实例 范围内的单例。</h4><p>假设 DaggerUserComponent 能够提供 User 实例</p>
<p>UserComponent 被自定义的  <code>@UserScope</code> 标注，那就意味着</p>
<p>一旦一个 DaggerUserComponent 实例创建完成，</p>
<p>那么其调用 injectTo 方法，进行注入时，所有注入的 <code>User</code> 对象都是同一个实例</p>
<p>知道 DaggerUserComponent 被重新创建，才会提供一个不一样的<code>User</code>实例</p>
<h4 id="2-Scope-的使用方法"><a href="#2-Scope-的使用方法" class="headerlink" title="(2) @Scope 的使用方法"></a>(2) <code>@Scope</code> 的使用方法</h4><p> 第一种</p>
<ol>
<li><code>@Scope</code> 注解整个 <code>Bean</code> 对象，<code>@inject</code> 注解对应 <code>Bean</code> 对象的构造方法</li>
<li><code>@Scope</code> 还需要在 <code>Bean</code> 对象注入，出现的 <code>Component</code> 中标注</li>
</ol>
<p>第二种</p>
<ol>
<li><code>@Scope</code> 配合 在<code>Module</code> 中使用，配合 <code>@Provides</code> 一起标注</li>
<li><code>@Scope</code> 需要在 <code>Module</code> 出现的 <code>Component</code> 中标注</li>
</ol>
<p>两种方法，其实就是两种提供实例的不同实现，对比前面 一二两篇文章即可看出</p>
<p>第一种是最简单注入时，加上<code>@Scope</code> </p>
<p>第二种是配合<code>@Module</code> 注入式，加上<code>@Scope</code></p>
<hr>
<h3 id="2-进行实践操作"><a href="#2-进行实践操作" class="headerlink" title="2. 进行实践操作"></a>2. 进行实践操作</h3><h4 id="1-整体结构构建"><a href="#1-整体结构构建" class="headerlink" title="(1) 整体结构构建"></a>(1) 整体结构构建</h4><p>实践的内容主要是针对 <code>@Scope</code> 第二种使用方法</p>
<p>因此这中间<code>@UserScope</code> 只需要添加到 <code>UserModule</code> 和 <code>UserComponent</code> 上</p>
<p><a href="https://github.com/flyer88/LearnDagger2/tree/%E5%AD%A6%E4%B9%A03Scope-%E4%BD%BF%E7%94%A8" target="_blank" rel="external">具体代码</a></p>
<p>整个类的结构</p>
<p><img src="http://ob9rvakdw.bkt.clouddn.com/代码结构.png" alt="代码结构"></p>
<p>创建三个 <code>Activity</code> 分别用于显示 <code>User</code> 实例</p>
<p>下面贴出部分代码</p>
<p>自定义  <code>UserScope.java</code> </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Scope</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> UserScope &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>User.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</div><div class="line">	...<span class="comment">//纯 Bean 对象,无任何特殊</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>UserComponent.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@UserScope</span><span class="comment">// 绑定 UserScope</span></div><div class="line"><span class="meta">@Component</span>(modules = &#123;UserModule.class&#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserComponent</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectTo</span><span class="params">(ClassARoomActivity classARoomActivity)</span></span>;</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">injectTo</span><span class="params">(ClassBRoomActivity classBRoomActivity)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>UserModule.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Module</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserModule</span> </span>&#123;</div><div class="line">	...</div><div class="line">    <span class="meta">@UserScope</span><span class="comment">// 绑定 UserScope</span></div><div class="line">    <span class="meta">@Provides</span></div><div class="line">    <span class="function">User <span class="title">provideUser</span><span class="params">()</span></span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> User();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>App.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="keyword">static</span> UserComponent sUserComponent;</div><div class="line">...</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> UserComponent <span class="title">getUserComponent</span><span class="params">()</span></span>&#123;<span class="comment">// 获取 DaggerUserComponent 对象</span></div><div class="line">       <span class="keyword">if</span> (sUserComponent == <span class="keyword">null</span>)&#123;</div><div class="line">           sUserComponent = DaggerUserComponent.builder().userModule(<span class="keyword">new</span> UserModule())</div><div class="line">                   .build();</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> sUserComponent;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">releaseUserComponent</span><span class="params">()</span></span>&#123; <span class="comment">// 清空 DaggerUserComponent 对象</span></div><div class="line">       sUserComponent = <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line">   ...</div></pre></td></tr></table></figure>
<h4 id="2-具体生成代码和调用分析"><a href="#2-具体生成代码和调用分析" class="headerlink" title="(2) 具体生成代码和调用分析"></a>(2) 具体生成代码和调用分析</h4><h5 id="a-代码生成部分分析"><a href="#a-代码生成部分分析" class="headerlink" title="a. 代码生成部分分析"></a>a. 代码生成部分分析</h5><p><code>DaggerUserComponent.java</code> 部分代码变化</p>
<p>未加上 <code>@UserScope</code> 时，<code>provideUserProvider</code> 的生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.provideUserProvider = UserModule_ProvideUserFactory.create(builder.userModule);</div></pre></td></tr></table></figure>
<p>加上 <code>@UserScope</code> 后，<code>provideUserProvider</code> 的生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.provideUserProvider =</div><div class="line">    DoubleCheck.provider(UserModule_ProvideUserFactory.create(builder.userModule));</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，虽然此处的 <code>provideUserProvider</code> 依然是 <code>Provider&lt;User&gt;</code> </p>
<p>但是，其实它的实例已经是 <code>DoubleCheck&lt;User&gt;</code> 类型的。</p>
</blockquote>
<p>跟进这个<code>DoubleCheck.provider()</code> 方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Provider&lt;T&gt; <span class="title">provider</span><span class="params">(Provider&lt;T&gt; delegate)</span> </span>&#123;</div><div class="line">   checkNotNull(delegate);</div><div class="line">   <span class="keyword">if</span> (delegate <span class="keyword">instanceof</span> DoubleCheck) &#123;</div><div class="line"><span class="comment">// 如果是 DoubleCheck 的实例，直接返回</span></div><div class="line">     <span class="keyword">return</span> delegate;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 否则创建一个，此处的 delegate 就是 UserModule_ProvideUserFactory.create(builder.userModule)</span></div><div class="line">   <span class="keyword">return</span> <span class="keyword">new</span> DoubleCheck&lt;T&gt;(delegate);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>跟进构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="title">DoubleCheck</span><span class="params">(Provider&lt;T&gt; provider)</span> </span>&#123;</div><div class="line">  <span class="keyword">assert</span> provider != <span class="keyword">null</span>;</div><div class="line">  <span class="keyword">this</span>.provider = provider;</div><div class="line">  <span class="comment">// 啥都没有，就是赋值了一个 provider 引用</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>所以综上，可以判断出，和之前的没有<code>@UserScope</code> 注解对比，具体的实例提供者改变了，不是生成<code>UserModule_ProvideUserFactory</code> 对象了，变成了<code>DoubleCheck&lt;User&gt;</code> 对象，其内部持有一个 <code>UserModule_ProvideUserFactory</code> 的引用。</p>
<h5 id="b-整体调用链"><a href="#b-整体调用链" class="headerlink" title="b.整体调用链"></a>b.整体调用链</h5><p> <code>DaggerUserComponent.injectTo</code> -&gt; <code>ClassARoomActivity_MembersInjector.injectMembers()</code> -&gt; <code>mUserProvider.get()</code> -&gt; <code>DoubleCheck&lt;User&gt;.get()</code></p>
<p>下面进行具体分析</p>
<ul>
<li><p><code>DaggerUserComponent.injectTo</code> -&gt; <code>ClassARoomActivity_MembersInjector.injectMembers()</code> 部分</p>
<p>因此其调用的实例也有了对应的改变，对应的<code>xxxInjector.java</code> 的<code>injectMemebers</code> 方法在调用时，会调用不同的实例</p>
<p>该部分代码和之前并无区别，主要是运行时，实例的区别    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectTo</span><span class="params">(ClassARoomActivity classARoomActivity)</span> </span>&#123;</div><div class="line">  classARoomActivityMembersInjector.injectMembers(classARoomActivity);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">injectMembers</span><span class="params">(ClassARoomActivity instance)</span> </span>&#123;</div><div class="line">  <span class="keyword">if</span> (instance == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Cannot inject members into a null reference"</span>);</div><div class="line">  &#125;</div><div class="line">  instance.mUser = mUserProvider.get();<span class="comment">// 注意该部分会调用不同的实例对应的方法</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
<li><p><code>mUserProvider.get()</code> -&gt; <code>DoubleCheck&lt;User&gt;.get()</code></p>
<p>未加上<code>@UserScop</code> 时，实例是 <code>UserModule_ProvideUserFactory</code></p>
<p>调用的是<code>UserModule_ProvideUserFactory.java</code> 中的方法，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> User <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> Preconditions.checkNotNull(</div><div class="line">    <span class="keyword">module</span>.provideUser(), <span class="string">"Cannot return null from a non-@Nullable @Provides method"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>加上<code>@UserScop</code> 时，实例是<code>DoubleCheck&lt;User&gt;</code></p>
<p>调用的是 <code>DoubleCheck&lt;T&gt;</code> 中的方法，如下，该部分也是实现 <code>Scope</code> 功能重要的一部分  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">            Object result = instance;</div><div class="line">            <span class="keyword">if</span> (result == UNINITIALIZED) &#123;<span class="comment">// 如果该对象从来没有初始化，那就初始化一次</span></div><div class="line">              <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">                result = instance;<span class="comment">// 获取最新实例，防止线程之间同时修改</span></div><div class="line">                <span class="keyword">if</span> (result == UNINITIALIZED) &#123;</div><div class="line">                  result = provider.get();<span class="comment">// 此处依旧调用了 UserModule_ProvideUserFactory.get() 方法</span></div><div class="line">                  Object currentInstance = instance;</div><div class="line">                  <span class="keyword">if</span> (currentInstance != UNINITIALIZED &amp;&amp; currentInstance != result) &#123;</div><div class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Scoped provider was invoked recursively returning "</span></div><div class="line"> + <span class="string">"different results: "</span> + currentInstance + <span class="string">" &amp; "</span> + result);</div><div class="line">            &#125;</div><div class="line">       instance = result;</div><div class="line">       <span class="comment">// 赋值最新的值</span></div><div class="line">       provider = <span class="keyword">null</span>;</div><div class="line">       <span class="comment">// 初始化一次以后，该对象对应的 Provider 在当前 Scope 中其实已经没有意义了，</span></div><div class="line">       <span class="comment">// 所以直接置为空，方便 GC 回收</span></div><div class="line">     &#125;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> <span class="keyword">return</span> (T) result;<span class="comment">// 返回结果</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，Provider 的置空</p>
<p>此处的置空不会影响数据的获取，该 <code>provider</code> 的引用就是下面方法中的 <code>UserModule_ProvideUserFactory.create(builder.userModule)</code> 对</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&gt;<span class="keyword">this</span>.provideUserProvider =  DoubleCheck.provider(UserModule_ProvideUserFactory.create(builder.userModule));</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
</li>
</ul>
<hr>
<h3 id="3-总结"><a href="#3-总结" class="headerlink" title="3. 总结"></a>3. 总结</h3><p>总结：</p>
<p><code>@UserScope</code> 作用于 <code>Component</code> 生命周期内</p>
<p>限制了被标注的实例提供者，只会实例化该对象一次，之后会抛弃对应的 <code>Provider</code> ，然后永远获取之前创建的<code>User</code></p>
<blockquote>
<p> <code>@UserScope @Provides provideUser()</code> ==&gt; <code>UserModule_ProviderUserFactory</code></p>
<p> 此处抛弃的就是 <code>UserModule_ProviderUserFactory</code> 的实例</p>
</blockquote>
<p>只有当实例化的 <code>Component</code> 对象被重新构建，被标注的实例提供者才会重新创建</p>
<p><img src="http://ob9rvakdw.bkt.clouddn.com/Dagger2%20%E5%AD%A6%E4%B9%A0%28%E4%B8%89%29.png" alt="Dagger2 学习(三)"></p>
<blockquote>
<p>一家之言，仅供参考</p>
<p><a href="https://github.com/flyer88/LearnDagger2/tree/%E5%AD%A6%E4%B9%A03Scope-%E4%BD%BF%E7%94%A8" target="_blank" rel="external">本文代码</a></p>
</blockquote>
</div></article></div></section><footer><div class="paginator"><a href="/2016/11/19/旧-LayoutInflater-源码流程记录/" class="next">下一篇</a></div><div data-thread-key="2016/11/21/dagger2-学习-三-scope-使用/" data-title="dagger2 学习(三)- scope 使用" data-url="http://dove.im/2016/11/21/dagger2-学习-三-scope-使用/" data-author-key="1" class="ds-thread"></div><script>var duoshuoQuery = {short_name:"baiyanwu"};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
     || document.getElementsByTagName('body')[0]).appendChild(ds);
})();

</script><div class="copyright"><p>© 2015 - 2017 <a href="http://dove.im">flyer</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>